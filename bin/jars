#!/usr/bin/php
<?php

define('APP_HOME', dirname(__DIR__));

const SUBSIMPLE_HOME = APP_HOME . '/vendor/oranfry/subsimple';
const JARS_CORE_HOME = APP_HOME . '/vendor/oranfry/jars-core';

require APP_HOME . '/lib.php';

$command = array_shift($argv);
$rem_argv = [];
$flags = [];

$parameters = [
    'username' => (object) ['short' => 'u'],
    'password' => (object) ['short' => 'p'],
    'token' => (object) ['short' => 't'],
    'portal_home' => (object) [],
    'db_home' => (object) [],
];

$arguments = array_map(fn () => null, $parameters);

for ($i = 0; $i < count($argv); $i++) {
    $matches = [];

    foreach ($parameters as $param => $details) {
        $pattern = '--' . str_replace('_', '-', $param) . '(?:=(.*))?';

        if ($short = @$details->short) {
            $pattern = '(?:-' . $short . '|' . $pattern . ')';
        }

        $pattern = '/^' . $pattern . '$/';

        if (preg_match($pattern, $argv[$i], $matches)) {
            $arguments[$param] = @$matches[1] ?? @$argv[++$i];

            continue 2;
        }
    }

    if (preg_match('/^-([a-zA-Z])$/', $argv[$i], $groups) || preg_match('/^--([a-zA-Z-]+)$/', $argv[$i], $groups)) {
        $flags[] = $groups[1];

        continue;
    }

    $rem_argv[] = $argv[$i];
}

$argv = array_merge([$command], $rem_argv);
$errors = [];

if (!$arguments['portal_home']) {
    $errors[] = 'portal_home not given';
}

if (!$arguments['db_home']) {
    $errors[] = 'db_home not given';
}

if (count($errors)) {
    error_log(implode('; ', $errors));
    usage($command, $parameters);
    exit(1);
}

define('PORTAL_HOME', $arguments['portal_home']);
define('DB_HOME', $arguments['db_home']);

if ($arguments['token']) {
    define('AUTH_TOKEN', $arguments['token']);
} else {
    if (!$arguments['password']) {
        if (!$arguments['username']) {
            $arguments['username'] = readline('Username: ');
        }

        echo "Password: ";
        $arguments['password'] = read_password();
    }

    if (!$arguments['username']) {
        error_log('Please supply username on the command line when supplying password that way');
        usage($command, $parameters);
        exit(1);
    }

    define('USERNAME', $arguments['username']);
    define('PASSWORD', $arguments['password']);
}

define('FLAGS', $flags);

unset($arguments, $command, $details, $flags, $i, $matches, $param, $parameters, $pattern, $rem_argv, $short);

require APP_HOME . '/vendor/autoload.php';
require PORTAL_HOME . '/vendor/autoload.php';
require SUBSIMPLE_HOME . '/subsimple.php';
